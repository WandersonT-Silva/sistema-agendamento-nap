<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novo Agendamento - Sistema NAP</title>
    <link rel="icon" type="image/png" sizes="32x32" href="logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="logo.png">
    <!-- MSAL.js para autenticação Microsoft -->
    <script src="https://alcdn.msauth.net/browser/2.24.0/js/msal-browser.min.js"></script>
    <style>
        /* ===== TEMA ESCOLA - SANTO ANTÔNIO ===== */
        :root {
            --dourado: #D4AF37;
            --laranja: #FF6B35;
            --azul-marinho: #1E3A8A;
            --branco: #FFFFFF;
            --cinza-claro: #F8FAFC;
            --cinza-medio: #6B7280;
            --cinza-escuro: #1F2937;
            --verde: #16A34A;
            --vermelho: #DC2626;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--cinza-claro) 0%, #e2e8f0 100%);
            min-height: 100vh;
            color: var(--cinza-escuro);
        }

        /* ===== CABEÇALHO SIMPLIFICADO ===== */
        .header {
            position: relative;
            height: 80px;
            background: var(--azul-marinho);
            box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
        }

        .header-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--azul-marinho);
            z-index: 1;
        }

        .header-content {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 30px;
            height: 100%;
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .logo {
            height: 50px;
            width: auto;
            filter: brightness(0) invert(1);
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        /* Status da Integração */
        .status-integracao {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--azul-marinho);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .status-integracao.conectado {
            background: var(--verde);
        }

        .status-integracao.erro {
            background: var(--vermelho);
        }

        /* ===== LAYOUT PRINCIPAL ===== */
        .main-layout {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        /* ===== MENU LATERAL ===== */
        .sidebar {
            width: 90px;
            background: var(--branco);
            box-shadow: 3px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 10;
            display: flex;
            flex-direction: column;
        }

        .menu-nav {
            list-style: none;
            padding: 20px 0;
            flex: 1;
        }

        .menu-item {
            position: relative;
            padding: 18px 0;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            margin: 5px 0;
        }

        .menu-item:hover {
            background: var(--cinza-claro);
            border-left-color: var(--laranja);
        }

        .menu-item.active {
            background: var(--azul-marinho);
            border-left-color: var(--dourado);
        }

        .menu-item.active .menu-icon {
            color: var(--branco);
            transform: scale(1.1);
        }

        .menu-item.active .menu-text {
            color: var(--branco);
            font-weight: 600;
        }

        .menu-icon {
            font-size: 22px;
            display: block;
            margin-bottom: 6px;
            color: var(--cinza-medio);
            transition: all 0.3s ease;
        }

        .menu-text {
            font-size: 11px;
            color: var(--cinza-medio);
            font-weight: 500;
            line-height: 1.2;
        }

        .menu-tooltip {
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: var(--azul-marinho);
            color: var(--branco);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            margin-left: 15px;
            box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
            border: 1px solid var(--dourado);
        }

        .menu-tooltip::before {
            content: '';
            position: absolute;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-right-color: var(--azul-marinho);
        }

        .menu-item:hover .menu-tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* ===== CONTEÚDO PRINCIPAL ===== */
        .content {
            flex: 1;
            padding: 30px;
            background: var(--cinza-claro);
            display: flex;
            gap: 30px;
            overflow-y: auto;
        }

        /* ===== PAINEL ESQUERDO ===== */
        .left-panel {
            width: 350px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .agendamento-selecionado {
            background: var(--branco);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--dourado);
        }

        .agendamento-selecionado h3 {
            color: var(--azul-marinho);
            font-size: 16px;
            font-weight: 600;
        }

        .actions-panel {
            background: var(--branco);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .agendamentos-list {
            flex: 1;
            background: var(--branco);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .agendamentos-list h3 {
            color: var(--azul-marinho);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .gallery {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .agendamento-item {
            background: var(--cinza-claro);
            padding: 15px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .agendamento-item:hover {
            border-color: var(--laranja);
            transform: translateY(-2px);
        }

        .agendamento-item.selected {
            border-color: var(--azul-marinho);
            background: rgba(30, 58, 138, 0.05);
        }

        .agendamento-disciplina {
            font-weight: 600;
            color: var(--azul-marinho);
            margin-bottom: 5px;
        }

        .agendamento-segmento {
            color: var(--cinza-medio);
            font-size: 14px;
            margin-bottom: 5px;
        }

        .agendamento-data {
            color: var(--cinza-escuro);
            font-size: 13px;
            margin-bottom: 5px;
        }

        .agendamento-observacoes {
            color: var(--cinza-medio);
            font-size: 12px;
            font-style: italic;
        }

        .sem-agendamentos {
            text-align: center;
            color: var(--cinza-medio);
            font-style: italic;
            padding: 40px 20px;
        }

        /* ===== PAINEL DIREITO ===== */
        .right-panel {
            flex: 1;
            background: var(--branco);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--dourado);
        }

        .agendamento-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: var(--azul-marinho);
            font-size: 14px;
        }

        .form-group label.required::after {
            content: ' *';
            color: var(--vermelho);
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: var(--branco);
        }

        .form-group select:focus,
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--azul-marinho);
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }

        .form-group select:disabled {
            background: #f9fafb;
            color: var(--cinza-medio);
            cursor: not-allowed;
        }

        .datetime-group .datetime-inputs {
            display: flex;
            gap: 15px;
        }

        .datetime-group input,
        .datetime-group select {
            flex: 1;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        /* ===== BOTÕES ===== */
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-agendar,
        .btn-limpar,
        .btn-excluir {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-agendar {
            background: linear-gradient(135deg, var(--laranja) 0%, var(--dourado) 100%);
            color: var(--branco);
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }

        .btn-agendar:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
        }

        .btn-agendar:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-limpar {
            background: var(--cinza-claro);
            color: var(--cinza-escuro);
            border: 2px solid var(--cinza-medio);
        }

        .btn-limpar:hover {
            background: var(--cinza-medio);
            color: var(--branco);
        }

        .btn-excluir {
            background: var(--vermelho);
            color: var(--branco);
            width: 100%;
            justify-content: center;
        }

        .btn-excluir:hover:not(:disabled) {
            background: #b91c1c;
            transform: translateY(-2px);
        }

        .btn-excluir:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-icon {
            font-size: 16px;
        }

        /* ===== LOADER ===== */
        .loader {
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== MODAL ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--branco);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 3px solid var(--dourado);
            max-width: 400px;
            width: 90%;
        }

        .modal-content h3 {
            color: var(--azul-marinho);
            margin-bottom: 15px;
            font-size: 24px;
        }

        .modal-content p {
            color: var(--cinza-escuro);
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .btn-ok {
            background: var(--azul-marinho);
            color: var(--branco);
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .btn-ok:hover {
            background: #1e40af;
            transform: translateY(-2px);
        }

        /* ===== RESPONSIVO ===== */
        @media (max-width: 1024px) {
            .content {
                flex-direction: column;
            }
            
            .left-panel {
                width: 100%;
                order: 2;
            }
            
            .right-panel {
                order: 1;
            }
        }

        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                flex-direction: row;
            }
            
            .menu-nav {
                display: flex;
                justify-content: space-around;
                padding: 10px 0;
                width: 100%;
            }
            
            .menu-item {
                padding: 10px 5px;
                border-left: none;
                border-bottom: 3px solid transparent;
                flex: 1;
            }
            
            .menu-item.active {
                border-left: none;
                border-bottom-color: var(--dourado);
            }
            
            .menu-tooltip {
                display: none;
            }
            
            .content {
                padding: 20px;
            }
            
            .datetime-group .datetime-inputs {
                flex-direction: column;
            }
            
            .form-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="agendamento-container">
        <!-- Status da Integração -->
        <div id="status-integracao" class="status-integracao" style="display: none;">
            🔄 Conectando...
        </div>

        <!-- Cabeçalho Simplificado -->
        <header class="header">
            <div class="header-background"></div>
            <div class="header-content">
                <div class="logo-container">
                    <img src="logo-santo-antonio.png" alt="Colégio Santo Antônio" class="logo">
                </div>
            </div>
        </header>

        <!-- Layout Principal -->
        <div class="main-layout">
            <!-- Menu Lateral SEM Logo -->
            <nav class="sidebar">
                <ul class="menu-nav">
                    <li class="menu-item" data-menu="1">
                        <span class="menu-icon">🏠</span>
                        <span class="menu-text">Início</span>
                        <span class="menu-tooltip">Página inicial</span>
                    </li>
                    <li class="menu-item active" data-menu="2">
                        <span class="menu-icon">📅</span>
                        <span class="menu-text">Agendar</span>
                        <span class="menu-tooltip">Novo agendamento</span>
                    </li>
                    <li class="menu-item" data-menu="3">
                        <span class="menu-icon">✉️</span>
                        <span class="menu-text">Suporte</span>
                        <span class="menu-tooltip">Contato e suporte</span>
                    </li>
                    <li class="menu-item" data-menu="4">
                        <span class="menu-icon">📆</span>
                        <span class="menu-text">Calendário</span>
                        <span class="menu-tooltip">Visualizar calendário</span>
                    </li>
                    <li class="menu-item" data-menu="5">
                        <span class="menu-icon">🔍</span>
                        <span class="menu-text">Buscar</span>
                        <span class="menu-tooltip">Busca por alunos</span>
                    </li>
                </ul>
            </nav>

            <!-- Conteúdo Principal -->
            <main class="content">
                <!-- Painel Esquerdo - Meus Agendamentos -->
                <div class="left-panel">
                    <div class="agendamento-selecionado">
                        <h3 id="selected-label">Nada selecionado</h3>
                    </div>
                    
                    <div class="actions-panel">
                        <button id="btn-excluir" class="btn-excluir" disabled>
                            <span class="btn-icon">🗑️</span>
                            EXCLUIR
                        </button>
                    </div>

                    <div class="agendamentos-list">
                        <h3>Meus Agendamentos</h3>
                        <div id="gallery-agendamentos" class="gallery">
                            <!-- Agendamentos serão carregados aqui via JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Painel Direito - Formulário -->
                <div class="right-panel">
                    <form id="form-agendamento" class="agendamento-form">
                        <!-- Disciplina -->
                        <div class="form-group">
                            <label for="disciplina" class="required">Disciplina</label>
                            <select id="disciplina" name="disciplina" required>
                                <option value="">Selecione uma disciplina</option>
                                <option value="Matemática">Matemática</option>
                                <option value="Língua Portuguesa">Língua Portuguesa</option>
                                <option value="História">História</option>
                                <option value="Geografia">Geografia</option>
                                <option value="Ciências">Ciências</option>
                                <option value="Artes">Artes</option>
                                <option value="Língua Inglesa">Língua Inglesa</option>
                                <option value="Química">Química</option>
                                <option value="Educação Física">Educação Física</option>
                                <option value="Biologia">Biologia</option>
                                <option value="Literatura">Literatura</option>
                                <option value="Gramática">Gramática</option>
                                <option value="Filosofia">Filosofia</option>
                                <option value="Sociologia">Sociologia</option>
                                <option value="Oficina de Texto">Oficina de Texto</option>
                                <option value="Raciocínio Lógico">Raciocínio Lógico</option>
                                <option value="Música">Música</option>
                                <option value="Condicionamento Físico no Esporte">Condicionamento Físico no Esporte</option>
                                <option value="Programação para Arduíno">Programação para Arduíno</option>
                                <option value="Cultura Digital">Cultura Digital</option>
                                <option value="Educação Financeira">Educação Financeira</option>
                                <option value="Sistemas para Internet">Sistemas para Internet</option>
                                <option value="Processos Criativos">Processos Criativos</option>
                                <option value="Psicologia e a Saúde Mental">Psicologia e a Saúde Mental</option>
                            </select>
                        </div>

                        <!-- Segmento -->
                        <div class="form-group">
                            <label for="segmento" class="required">Segmento</label>
                            <select id="segmento" name="segmento" required>
                                <option value="">Selecione o segmento</option>
                                <option value="Fundamental 1">Fundamental 1</option>
                                <option value="Fundamental 2">Fundamental 2</option>
                                <option value="Ensino Médio">Ensino Médio</option>
                            </select>
                        </div>

                        <!-- Turma/Série -->
                        <div class="form-group">
                            <label for="turma" class="required">Turma/Série</label>
                            <select id="turma" name="turma" required>
                                <option value="">Selecione a turma</option>
                                <!-- Turmas serão carregadas dinamicamente -->
                            </select>
                        </div>

                        <!-- Data/Hora -->
                        <div class="form-group datetime-group">
                            <label for="data" class="required">Período</label>
                            <div class="datetime-inputs">
                                <input type="date" id="data" name="data" required min="">
                                <select id="hora" name="hora" required disabled>
                                    <option value="">Selecione o horário</option>
                                    <!-- Horários serão carregados dinamicamente -->
                                </select>
                            </div>
                        </div>

                        <!-- Observações -->
                        <div class="form-group">
                            <label for="observacoes" class="required">Observações</label>
                            <textarea id="observacoes" name="observacoes" 
                                      placeholder="N/A; utilizar calculadora; prova em dupla; com consulta..." 
                                      required></textarea>
                        </div>
                    </form>

                    <!-- Botões de Ação -->
                    <div class="form-actions">
                        <button id="btn-limpar" class="btn-limpar">
                            <span class="btn-icon">❌</span>
                            LIMPAR
                        </button>
                        <button id="btn-agendar" class="btn-agendar" disabled>
                            <span class="btn-icon">📨</span>
                            <span id="btn-text">AGENDAR</span>
                            <div id="btn-loader" class="loader" style="display: none;"></div>
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="modal-confirmacao" class="modal">
        <div class="modal-content">
            <h3>Agendamento Confirmado!</h3>
            <p>Seu agendamento foi registrado com sucesso.</p>
            <p>Um e-mail de confirmação foi enviado para você.</p>
            <button id="btn-modal-ok" class="btn-ok">OK</button>
        </div>
    </div>

    <script>
        // ✅ CONFIGURAÇÃO DE URLS ABSOLUTAS
        const BASE_URL = 'https://wandersont-silva.github.io/sistema-agendamento-nap';
        
        // ✅ CONFIGURAÇÃO MICROSOFT LIST COM SEUS DADOS
        const MS_LIST_CONFIG = {
            siteUrl: 'https://inesacsa-my.sharepoint.com/personal/wandeson_silva_santoantonio_edu_br',
            listName: 'NAP',
            clientId: '9b518380-2b14-46d7-8a5a-e5a815b48aac',
            tenantId: '9d4a2bfa-8172-4b94-bd8a-eafb5cf478cc',
            redirectUri: `${BASE_URL}/agendamento.html`
        };

        // ✅ CONFIGURAÇÃO MSAL
        const msalConfig = {
            auth: {
                clientId: MS_LIST_CONFIG.clientId,
                authority: `https://login.microsoftonline.com/${MS_LIST_CONFIG.tenantId}`,
                redirectUri: MS_LIST_CONFIG.redirectUri,
                knownAuthorities: ['login.microsoftonline.com']
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: false
            }
        };

        const msalRequest = {
            scopes: [
                "https://graph.microsoft.com/Sites.ReadWrite.All",
                "https://graph.microsoft.com/Files.ReadWrite.All", 
                "https://graph.microsoft.com/User.Read",
                "https://graph.microsoft.com/Mail.Send" 
            ]
        };

        // ✅ GERENCIADOR DE AUTENTICAÇÃO MSAL
        class MSALAuthManager {
            constructor() {
                this.msalInstance = null;
                this.account = null;
                this.isInitialized = false;
            }

            async initialize() {
                if (this.isInitialized) return;
                
                try {
                    this.msalInstance = new msal.PublicClientApplication(msalConfig);
                    await this.msalInstance.initialize();
                    
                    const response = await this.msalInstance.handleRedirectPromise();
                    if (response) {
                        this.account = response.account;
                        console.log('✅ Login via redirect realizado:', this.account);
                    } else {
                        const accounts = this.msalInstance.getAllAccounts();
                        if (accounts.length > 0) {
                            this.account = accounts[0];
                            console.log('✅ Conta encontrada no cache:', this.account);
                        }
                    }
                    
                    this.isInitialized = true;
                } catch (error) {
                    console.error('❌ Erro ao inicializar MSAL:', error);
                }
            }

            async getAccessToken() {
                if (!this.isInitialized) {
                    await this.initialize();
                }

                if (!this.account) {
                    await this.login();
                    return null;
                }

                try {
                    const silentRequest = {
                        scopes: msalRequest.scopes,
                        account: this.account,
                        forceRefresh: false
                    };

                    const response = await this.msalInstance.acquireTokenSilent(silentRequest);
                    console.log('✅ Token adquirido silenciosamente');
                    return response.accessToken;

                } catch (silentError) {
                    console.warn('Falha no token silencioso:', silentError);
                    
                    try {
                        const response = await this.msalInstance.acquireTokenPopup(msalRequest);
                        this.account = response.account;
                        return response.accessToken;
                    } catch (popupError) {
                        console.error('Erro no popup:', popupError);
                        throw new Error('Falha na aquisição do token');
                    }
                }
            }

            async login() {
                if (!this.isInitialized) {
                    await this.initialize();
                }

                try {
                    const loginRequest = {
                        scopes: msalRequest.scopes,
                        prompt: "select_account"
                    };
                    
                    const response = await this.msalInstance.loginPopup(loginRequest);
                    this.account = response.account;
                    console.log('✅ Login realizado via popup');
                    return response;
                    
                } catch (error) {
                    console.error('❌ Erro no login:', error);
                    throw error;
                }
            }

            isAuthenticated() {
                return this.account !== null;
            }
        }

        // ✅ GERENCIADOR PRINCIPAL DE AGENDAMENTOS
        class AgendamentoManager {
            constructor() {
                this.authManager = new MSALAuthManager();
                this.agendamentos = [];
                this.agendamentoSelecionado = null;
                this.horariosPorSegmento = {
                    'Fundamental 1': [
                        '07:00', '07:45', '08:30', '09:15', '10:00', '10:45',
                        '13:00', '13:45', '14:30', '15:15', '16:00'
                    ],
                    'Fundamental 2': [
                        '07:00', '07:45', '08:30', '09:15', '10:00', '10:45', '11:30',
                        '13:00', '13:45', '14:30', '15:15', '16:00', '16:45'
                    ],
                    'Ensino Médio': [
                        '07:00', '07:45', '08:30', '09:15', '10:00', '10:45', '11:30',
                        '13:00', '13:45', '14:30', '15:15', '16:00', '16:45', '17:30'
                    ]
                };
                
                this.turmasPorSegmento = {
                    'Fundamental 1': ['1º A', '1º B', '1º C', '1º D', '1º E', '2º A', '2º B', '2º C', '2º D', '2º E', '3º A', '3º B', '3º C', '3º D', '3º E', '4º A', '4º B', '4º C', '4º D', '4º E', '5º A', '5º B', '5º C', '5º D','5º E'],
                    'Fundamental 2': ['6º A', '6º B', '6º C', '6º D', '6º E', '7º A', '7º B', '7º C', '7º D', '7º E', '8º A', '8º B', '8º C', '8º D','8º E', '9º A', '9º B', '9º C', '9º D', '9º E'],
                    'Ensino Médio': ['1º A', '1º B', '1º C', '1º D', '1º E', '2º A', '2º B', '2º C', '2º D', '2º E', '3º A', '3º B', '3º C', '3º D', '3º E']
                };
                
                this.init();
            }

            async init() {
                await this.authManager.initialize();
                this.checkAuthentication();
                this.setupEventListeners();
                this.setupMenuNavigation();
                await this.carregarAgendamentos();
                this.configurarValidacoes();
                await this.testarIntegracaoMicrosoftList();
            }

            checkAuthentication() {
                const currentUser = localStorage.getItem('currentUser');
                if (!currentUser) {
                    window.location.href = BASE_URL + '/index.html';
                    return;
                }
                this.usuarioLogado = JSON.parse(currentUser);
            }

            setupEventListeners() {
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const menuId = parseInt(item.getAttribute('data-menu'));
                        this.navigateToMenu(menuId);
                    });
                });

                document.getElementById('segmento').addEventListener('change', (e) => {
                    this.atualizarTurmas(e.target.value);
                    this.atualizarHorarios(e.target.value);
                    this.validarFormulario();
                });

                document.getElementById('data').addEventListener('change', (e) => {
                    this.validarData(e.target.value);
                    this.validarFormulario();
                });

                const campos = ['disciplina', 'turma', 'hora', 'observacoes'];
                campos.forEach(campo => {
                    document.getElementById(campo).addEventListener('change', () => {
                        this.validarFormulario();
                    });
                });

                document.getElementById('btn-agendar').addEventListener('click', () => {
                    this.submeterAgendamento();
                });

                document.getElementById('btn-limpar').addEventListener('click', () => {
                    this.limparFormulario();
                });

                document.getElementById('btn-excluir').addEventListener('click', () => {
                    this.excluirAgendamento();
                });

                document.getElementById('btn-modal-ok').addEventListener('click', () => {
                    this.fecharModal();
                });
            }

            setupMenuNavigation() {
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const currentMenu = document.querySelector('[data-menu="2"]');
                if (currentMenu) {
                    currentMenu.classList.add('active');
                }
            }

            navigateToMenu(menuId) {
                switch(menuId) {
                    case 1:
                        window.location.href = BASE_URL + '/dashboard.html';
                        break;
                    case 2:
                        break;
                    case 3:
                        window.location.href = BASE_URL + '/suporte.html';
                        break;
                    case 4:
                        window.location.href = BASE_URL + '/calendario.html';
                        break;
                    case 5:
                        window.location.href = BASE_URL + '/busca.html';
                        break;
                }
            }

            // ✅ MÉTODOS DE INTEGRAÇÃO MICROSOFT LIST
            async testarIntegracaoMicrosoftList() {
                try {
                    this.mostrarStatusIntegracao('🔄 Conectando com Microsoft List...');
                    
                    const token = await this.authManager.getAccessToken();
                    if (!token) {
                        this.mostrarStatusIntegracao('⚠️ Faça login na Microsoft', 'erro');
                        return;
                    }

                    const sitePath = this.extrairSitePath(MS_LIST_CONFIG.siteUrl);
                    const response = await fetch(
                        `https://graph.microsoft.com/v1.0/sites/${sitePath}/lists/${MS_LIST_CONFIG.listName}`,
                        {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        }
                    );

                    if (response.ok) {
                        const data = await response.json();
                        MS_LIST_CONFIG.listId = data.id;
                        this.mostrarStatusIntegracao('✅ Conectado à Microsoft List', 'conectado');
                        console.log('✅ List ID encontrado:', data.id);
                    } else {
                        this.mostrarStatusIntegracao('❌ Lista não encontrada', 'erro');
                    }
                    
                } catch (error) {
                    console.error('❌ Erro na integração:', error);
                    this.mostrarStatusIntegracao('❌ Erro na conexão', 'erro');
                }
            }

            mostrarStatusIntegracao(mensagem, tipo = '') {
                const statusElement = document.getElementById('status-integracao');
                if (statusElement) {
                    statusElement.textContent = mensagem;
                    statusElement.className = `status-integracao ${tipo}`;
                    statusElement.style.display = 'block';
                }
            }

            extrairSitePath(siteUrl) {
                const url = new URL(siteUrl);
                return `${url.hostname}:${url.pathname}`;
            }

            async carregarAgendamentos() {
                try {
                    const token = await this.authManager.getAccessToken();
                    let agendamentosDaList = null;

                    if (token) {
                        agendamentosDaList = await this.carregarDaMicrosoftList(token);
                    }

                    if (agendamentosDaList && agendamentosDaList.length > 0) {
                        this.agendamentos = agendamentosDaList;
                        console.log('✅ Agendamentos carregados da Microsoft List');
                    } else {
                        await this.carregarAgendamentosLocal();
                    }
                    
                    this.renderizarAgendamentos();
                } catch (error) {
                    console.error('Erro ao carregar agendamentos:', error);
                    await this.carregarAgendamentosLocal();
                    this.renderizarAgendamentos();
                }
            }

            async carregarDaMicrosoftList(token) {
                try {
                    const sitePath = this.extrairSitePath(MS_LIST_CONFIG.siteUrl);
                    
                    const response = await fetch(
                        `https://graph.microsoft.com/v1.0/sites/${sitePath}/lists/${MS_LIST_CONFIG.listName}/items?expand=fields&$top=1000`,
                        {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        }
                    );

                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    return data.value.map(item => ({
                        id: item.id,
                        microsoftId: item.id,
                        disciplina: item.fields.Disciplina,
                        segmento: item.fields.Segmento,
                        turma: item.fields.Turma,
                        dataHora: item.fields.Time,
                        observacoes: item.fields.Observacoes,
                        usuario: item.fields.User,
                        dataCriacao: item.fields.Criado
                    }));

                } catch (error) {
                    console.warn('Não foi possível carregar da Microsoft List:', error);
                    return null;
                }
            }

            async salvarNaMicrosoftList(agendamento, token) {
                try {
                    const sitePath = this.extrairSitePath(MS_LIST_CONFIG.siteUrl);
                    
                    const payload = {
                        fields: {
                            Title: `Agendamento - ${agendamento.disciplina} - ${agendamento.turma}`,
                            Disciplina: agendamento.disciplina,
                            Segmento: agendamento.segmento,
                            Turma: agendamento.turma,
                            Time: agendamento.dataHora,
                            Observacoes: agendamento.observacoes,
                            User: agendamento.usuario
                        }
                    };

                    console.log('📤 Enviando para Microsoft List:', payload);

                    const response = await fetch(
                        `https://graph.microsoft.com/v1.0/sites/${sitePath}/lists/${MS_LIST_CONFIG.listName}/items`,
                        {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        }
                    );

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erro HTTP: ${response.status} - ${errorText}`);
                    }

                    const data = await response.json();
                    console.log('✅ Salvo com sucesso na List:', data);
                    
                    return {
                        id: data.id,
                        microsoftId: data.id
                    };

                } catch (error) {
                    console.error('Erro ao salvar na Microsoft List:', error);
                    throw error;
                }
            }

            async excluirDaMicrosoftList(microsoftId) {
                try {
                    const token = await this.authManager.getAccessToken();
                    const sitePath = this.extrairSitePath(MS_LIST_CONFIG.siteUrl);
                    
                    const response = await fetch(
                        `https://graph.microsoft.com/v1.0/sites/${sitePath}/lists/${MS_LIST_CONFIG.listName}/items/${microsoftId}`,
                        {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        }
                    );

                    if (!response.ok && response.status !== 404) {
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }

                    return true;

                } catch (error) {
                    console.error('Erro ao excluir da Microsoft List:', error);
                    throw error;
                }
            }

            async verificarDisponibilidadeMicrosoftList() {
                try {
                    const segmento = document.getElementById('segmento').value;
                    const data = document.getElementById('data').value;
                    const hora = document.getElementById('hora').value;
                    
                    const dataHoraSelecionada = new Date(`${data}T${hora}:00`);
                    
                    const token = await this.authManager.getAccessToken();
                    const todosAgendamentos = await this.carregarDaMicrosoftList(token);
                    
                    if (!todosAgendamentos) {
                        return this.verificarDisponibilidadeLocal();
                    }
                    
                    const agendamentosNoMesmoHorario = todosAgendamentos.filter(ag => {
                        if (!ag.dataHora) return false;
                        
                        const agDataHora = new Date(ag.dataHora);
                        return ag.segmento === segmento && 
                               agDataHora.getTime() === dataHoraSelecionada.getTime();
                    });
                    
                    console.log(`📊 Verificação: ${agendamentosNoMesmoHorario.length}/2 agendamentos no horário`);
                    
                    return agendamentosNoMesmoHorario.length < 2;

                } catch (error) {
                    console.warn('Erro ao verificar disponibilidade na List:', error);
                    return this.verificarDisponibilidadeLocal();
                }
            }

            // ✅ MÉTODOS LOCAIS (FALLBACK)
            async carregarAgendamentosLocal() {
                const agendamentosSalvos = localStorage.getItem(`agendamentos_${this.usuarioLogado.email}`);
                this.agendamentos = agendamentosSalvos ? JSON.parse(agendamentosSalvos) : [];
            }

            salvarAgendamentosLocal() {
                localStorage.setItem(`agendamentos_${this.usuarioLogado.email}`, JSON.stringify(this.agendamentos));
            }

            verificarDisponibilidadeLocal() {
                const segmento = document.getElementById('segmento').value;
                const data = document.getElementById('data').value;
                const hora = document.getElementById('hora').value;
                
                const dataHoraSelecionada = new Date(`${data}T${hora}:00`);
                const agendamentosNoMesmoHorario = this.agendamentos.filter(ag => {
                    const agDataHora = new Date(ag.dataHora);
                    return ag.segmento === segmento && 
                           agDataHora.getTime() === dataHoraSelecionada.getTime();
                });
                
                return agendamentosNoMesmoHorario.length < 2;
            }

            // ✅ MÉTODOS EXISTENTES (ATUALIZADOS)
            async submeterAgendamento() {
                if (!this.validarFormulario()) {
                    alert('Por favor, preencha todos os campos obrigatórios.');
                    return;
                }

                const btnAgendar = document.getElementById('btn-agendar');
                const btnText = document.getElementById('btn-text');
                const btnLoader = document.getElementById('btn-loader');

                btnText.textContent = 'ENVIANDO...';
                btnLoader.style.display = 'block';
                btnAgendar.disabled = true;

                try {
                    const disponivel = await this.verificarDisponibilidadeMicrosoftList();
                    
                    if (!disponivel) {
                        alert('Já existem 2 agendamentos para este período e segmento. Escolha outro horário.');
                        return;
                    }

                    const novoAgendamento = this.criarAgendamento();
                    const token = await this.authManager.getAccessToken();
                    
                    if (token) {
                        const agendamentoSalvo = await this.salvarNaMicrosoftList(novoAgendamento, token);
                        if (agendamentoSalvo) {
                            novoAgendamento.id = agendamentoSalvo.id;
                            novoAgendamento.microsoftId = agendamentoSalvo.microsoftId;
                        }
                    }
                    
                    this.agendamentos.push(novoAgendamento);
                    this.salvarAgendamentosLocal();
                    await this.enviarEmailConfirmacao(novoAgendamento);
                    this.mostrarModalConfirmacao();
                    this.limparFormulario();
                    this.renderizarAgendamentos();
                    
                } catch (error) {
                    console.error('Erro ao agendar:', error);
                    alert('Erro ao realizar agendamento. Tente novamente.');
                } finally {
                    btnText.textContent = 'AGENDAR';
                    btnLoader.style.display = 'none';
                    this.validarFormulario();
                }
            }

            async excluirAgendamento() {
                if (this.agendamentoSelecionado === null) {
                    alert('Nenhum agendamento selecionado para excluir.');
                    return;
                }

                if (!confirm('Tem certeza que deseja excluir este agendamento?')) {
                    return;
                }

                const agendamento = this.agendamentos[this.agendamentoSelecionado];
                
                try {
                    if (agendamento.microsoftId) {
                        await this.excluirDaMicrosoftList(agendamento.microsoftId);
                    }
                    
                    this.agendamentos.splice(this.agendamentoSelecionado, 1);
                    this.agendamentoSelecionado = null;
                    
                    this.salvarAgendamentosLocal();
                    this.renderizarAgendamentos();
                    
                    const label = document.getElementById('selected-label');
                    const btnExcluir = document.getElementById('btn-excluir');
                    
                    label.textContent = 'Nada selecionado';
                    btnExcluir.disabled = true;
                    
                    alert('Agendamento excluído com sucesso!');
                    
                } catch (error) {
                    console.error('Erro ao excluir:', error);
                    alert('Erro ao excluir agendamento. Tente novamente.');
                }
            }

            // ... (outros métodos permanecem iguais)
            atualizarTurmas(segmento) {
                const selectTurma = document.getElementById('turma');
                selectTurma.innerHTML = '<option value="">Selecione a turma</option>';
                
                if (segmento && this.turmasPorSegmento[segmento]) {
                    this.turmasPorSegmento[segmento].forEach(turma => {
                        const option = document.createElement('option');
                        option.value = turma;
                        option.textContent = turma;
                        selectTurma.appendChild(option);
                    });
                }
            }

            atualizarHorarios(segmento) {
                const selectHora = document.getElementById('hora');
                selectHora.innerHTML = '<option value="">Selecione o horário</option>';
                selectHora.disabled = !segmento;
                
                if (segmento && this.horariosPorSegmento[segmento]) {
                    this.horariosPorSegmento[segmento].forEach(horario => {
                        const option = document.createElement('option');
                        option.value = horario;
                        option.textContent = horario;
                        selectHora.appendChild(option);
                    });
                }
            }

            validarData(data) {
                const dataSelecionada = new Date(data);
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                
                if (dataSelecionada <= hoje) {
                    alert('Não é permitido selecionar a data de hoje ou datas passadas. Por favor, escolha uma data futura.');
                    document.getElementById('data').value = '';
                    return false;
                }
                return true;
            }

            validarFormulario() {
                const disciplina = document.getElementById('disciplina').value;
                const segmento = document.getElementById('segmento').value;
                const turma = document.getElementById('turma').value;
                const data = document.getElementById('data').value;
                const hora = document.getElementById('hora').value;
                const observacoes = document.getElementById('observacoes').value;
                
                const formValido = disciplina && segmento && turma && data && hora && observacoes;
                
                document.getElementById('btn-agendar').disabled = !formValido;
                
                return formValido;
            }

            renderizarAgendamentos() {
                const gallery = document.getElementById('gallery-agendamentos');
                gallery.innerHTML = '';

                if (this.agendamentos.length === 0) {
                    gallery.innerHTML = '<p class="sem-agendamentos">Nenhum agendamento encontrado</p>';
                    return;
                }

                this.agendamentos.forEach((agendamento, index) => {
                    const item = document.createElement('div');
                    item.className = `agendamento-item ${this.agendamentoSelecionado === index ? 'selected' : ''}`;
                    item.innerHTML = `
                        <div class="agendamento-disciplina">${agendamento.disciplina}</div>
                        <div class="agendamento-segmento">${agendamento.segmento} - ${agendamento.turma}</div>
                        <div class="agendamento-data">${this.formatarDataHora(agendamento.dataHora)}</div>
                        <div class="agendamento-observacoes">Observações: ${agendamento.observacoes}</div>
                    `;
                    
                    item.addEventListener('click', () => {
                        this.selecionarAgendamento(index);
                    });
                    
                    gallery.appendChild(item);
                });
            }

            selecionarAgendamento(index) {
                this.agendamentoSelecionado = index;
                this.renderizarAgendamentos();
                
                const label = document.getElementById('selected-label');
                const btnExcluir = document.getElementById('btn-excluir');
                
                if (this.agendamentoSelecionado !== null) {
                    label.textContent = 'Agendamento selecionado';
                    btnExcluir.disabled = false;
                } else {
                    label.textContent = 'Nada selecionado';
                    btnExcluir.disabled = true;
                }
            }

            criarAgendamento() {
                const disciplina = document.getElementById('disciplina').value;
                const segmento = document.getElementById('segmento').value;
                const turma = document.getElementById('turma').value;
                const data = document.getElementById('data').value;
                const hora = document.getElementById('hora').value;
                const observacoes = document.getElementById('observacoes').value;

                const [horas, minutos] = hora.split(':');
                const dataHora = new Date(data);
                dataHora.setHours(parseInt(horas), parseInt(minutos), 0, 0);

                return {
                    id: this.gerarId(),
                    disciplina: disciplina,
                    segmento: segmento,
                    turma: turma,
                    dataHora: dataHora.toISOString(),
                    observacoes: observacoes,
                    usuario: this.usuarioLogado.email,
                    dataCriacao: new Date().toISOString()
                };
            }

            async enviarEmailConfirmacao(agendamento) {
    try {
        const token = await this.authManager.getAccessToken();
        if (!token) {
            console.warn('❌ Não foi possível obter token para enviar email');
            return false;
        }

        const dataFormatada = this.formatarDataHora(agendamento.dataHora);
        
        // ✅ Email formatado profissionalmente
        const emailPayload = {
            message: {
                subject: `✅ Confirmação de Agendamento - ${agendamento.disciplina}`,
                body: {
                    contentType: "HTML",
                    content: `
                        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                            <!-- Cabeçalho -->
                            <div style="background: #1E3A8A; color: white; padding: 20px; text-align: center; border-radius: 10px 10px 0 0;">
                                <h1 style="margin: 0;">🎓 Colégio Santo Antônio</h1>
                                <h2 style="margin: 10px 0 0 0;">Sistema NAP - Agendamento Confirmado</h2>
                            </div>
                            
                            <!-- Conteúdo -->
                            <div style="padding: 25px; background: #f8fafc;">
                                <p style="font-size: 16px;">Prezado(a) professor(a),</p>
                                <p style="font-size: 16px;">Seu agendamento foi registrado com sucesso no sistema.</p>
                                
                                <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #D4AF37; margin: 20px 0;">
                                    <h3 style="color: #1E3A8A; margin-top: 0;">📅 Detalhes do Agendamento</h3>
                                    <table style="width: 100%;">
                                        <tr>
                                            <td style="padding: 8px 0; font-weight: bold; width: 120px;">Disciplina:</td>
                                            <td style="padding: 8px 0;">${agendamento.disciplina}</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 8px 0; font-weight: bold;">Segmento:</td>
                                            <td style="padding: 8px 0;">${agendamento.segmento}</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 8px 0; font-weight: bold;">Turma:</td>
                                            <td style="padding: 8px 0;">${agendamento.turma}</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 8px 0; font-weight: bold;">Data/Hora:</td>
                                            <td style="padding: 8px 0;">${dataFormatada}</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 8px 0; font-weight: bold; vertical-align: top;">Observações:</td>
                                            <td style="padding: 8px 0;">${agendamento.observacoes}</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <p style="font-size: 14px; color: #6B7280;">
                                    <em>Este é um email automático de confirmação. Não responda este email.</em>
                                </p>
                            </div>
                            
                            <!-- Rodapé -->
                            <div style="background: #D4AF37; color: white; padding: 15px; text-align: center; border-radius: 0 0 10px 10px;">
                                <p style="margin: 0; font-size: 14px;">
                                    Sistema de Agendamento NAP - Colégio Santo Antônio<br>
                                    <small>${new Date().getFullYear()} - Todos os direitos reservados</small>
                                </p>
                            </div>
                        </div>
                    `
                },
                toRecipients: [
                    {
                        emailAddress: {
                            address: agendamento.usuario
                        }
                    }
                ]
            },
            saveToSentItems: "true"
        };

        console.log('📧 Enviando email para:', agendamento.usuario);

        const response = await fetch(
            'https://graph.microsoft.com/v1.0/me/sendMail',
            {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(emailPayload)
            }
        );

        if (response.ok) {
            console.log('✅ Email de confirmação enviado com sucesso!');
            return true;
        } else {
            const errorText = await response.text();
            console.error('❌ Erro ao enviar email:', errorText);
            return false;
        }

    } catch (error) {
        console.error('❌ Erro no envio de email:', error);
        return false;
    }
}
            
            limparFormulario() {
                document.getElementById('form-agendamento').reset();
                document.getElementById('hora').disabled = true;
                document.getElementById('hora').innerHTML = '<option value="">Selecione o horário</option>';
                document.getElementById('turma').innerHTML = '<option value="">Selecione a turma</option>';
                this.validarFormulario();
            }

            mostrarModalConfirmacao() {
                document.getElementById('modal-confirmacao').style.display = 'flex';
            }

            fecharModal() {
                document.getElementById('modal-confirmacao').style.display = 'none';
            }

            gerarId() {
                return 'agendamento_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            formatarDataHora(dataHoraISO) {
                const data = new Date(dataHoraISO);
                return data.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            configurarValidacoes() {
                const amanha = new Date();
                amanha.setDate(amanha.getDate() + 1);
                const dataInput = document.getElementById('data');
                dataInput.min = amanha.toISOString().split('T')[0];
            }
        }

        // Inicializar quando a página carregar
        document.addEventListener('DOMContentLoaded', () => {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = BASE_URL + '/index.html';
                return;
            }
            new AgendamentoManager();
        });
    </script>
</body>
</html>


