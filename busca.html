<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Busca - Sistema NAP</title>
    <link rel="icon" type="image/png" sizes="32x32" href="logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="logo.png">
    <!-- MSAL.js para integração com Microsoft Excel -->
    <script src="https://alcdn.msauth.net/browser/2.24.0/js/msal-browser.min.js"></script>
    <style>
        /* ===== TEMA ESCOLA - SANTO ANTÔNIO ===== */
        :root {
            /* Cores oficiais da escola */
            --dourado: #D4AF37;         /* Dourado clássico */
            --laranja: #FF6B35;         /* Laranja vibrante */
            --azul-marinho: #1E3A8A;    /* Azul marinho */
            --branco: #FFFFFF;          /* Branco */
            --cinza-claro: #F8FAFC;     /* Cinza muito claro */
            --cinza-medio: #6B7280;     /* Cinza médio */
            --cinza-escuro: #1F2937;    /* Cinza escuro */
            --verde: #16A34A;           /* Verde para status */
            --vermelho: #DC2626;        /* Vermelho para erros */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--cinza-claro) 0%, #e2e8f0 100%);
            min-height: 100vh;
            color: var(--cinza-escuro);
        }

        /* ===== CABEÇALHO SIMPLIFICADO ===== */
        .header {
            position: relative;
            height: 80px;
            background: var(--azul-marinho);
            box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
        }

        .header-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--azul-marinho);
            z-index: 1;
        }

        .header-content {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 30px;
            height: 100%;
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .logo {
            height: 50px;
            width: auto;
            filter: brightness(0) invert(1);
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        /* Status da Integração */
        .status-integracao {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--azul-marinho);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .status-integracao.conectado {
            background: var(--verde);
        }

        .status-integracao.erro {
            background: var(--vermelho);
        }

        /* ===== LAYOUT PRINCIPAL ===== */
        .main-layout {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        /* ===== MENU LATERAL SEM LOGO ===== */
        .sidebar {
            width: 90px;
            background: var(--branco);
            box-shadow: 3px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 10;
            display: flex;
            flex-direction: column;
        }

        .menu-nav {
            list-style: none;
            padding: 20px 0;
            flex: 1;
        }

        .menu-item {
            position: relative;
            padding: 18px 0;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            margin: 5px 0;
        }

        .menu-item:hover {
            background: var(--cinza-claro);
            border-left-color: var(--laranja);
        }

        .menu-item.active {
            background: var(--azul-marinho);
            border-left-color: var(--dourado);
        }

        .menu-item.active .menu-icon {
            color: var(--branco);
            transform: scale(1.1);
        }

        .menu-item.active .menu-text {
            color: var(--branco);
            font-weight: 600;
        }

        .menu-icon {
            font-size: 22px;
            display: block;
            margin-bottom: 6px;
            color: var(--cinza-medio);
            transition: all 0.3s ease;
        }

        .menu-text {
            font-size: 11px;
            color: var(--cinza-medio);
            font-weight: 500;
            line-height: 1.2;
        }

        .menu-tooltip {
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: var(--azul-marinho);
            color: var(--branco);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            margin-left: 15px;
            box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
            border: 1px solid var(--dourado);
        }

        .menu-tooltip::before {
            content: '';
            position: absolute;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-right-color: var(--azul-marinho);
        }

        .menu-item:hover .menu-tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* ===== CONTEÚDO PRINCIPAL ===== */
        .content {
            flex: 1;
            padding: 30px;
            background: var(--cinza-claro);
            overflow-y: auto;
        }

        .busca-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        /* ===== PAINEL DE FILTROS ===== */
        .filtros-panel {
            background: var(--branco);
            border: 2px solid var(--azul-marinho);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .filtro-group {
            display: flex;
            align-items: flex-end;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filtro-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            min-width: 200px;
        }

        .filtro-item label {
            font-weight: 600;
            color: var(--azul-marinho);
            font-size: 14px;
        }

        .filtro-item select {
            padding: 12px 15px;
            border: 2px solid var(--cinza-claro);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: var(--branco);
            font-family: inherit;
        }

        .filtro-item select:focus {
            outline: none;
            border-color: var(--azul-marinho);
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }

        .filtro-item select:disabled {
            border-color: var(--cinza-medio);
            background: var(--cinza-claro);
            color: var(--cinza-medio);
        }

        .btn-filtro {
            background: linear-gradient(135deg, var(--azul-marinho) 0%, var(--laranja) 100%);
            color: var(--branco);
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
            min-width: 150px;
            height: 46px;
        }

        .btn-filtro:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 138, 0.4);
        }

        .btn-filtro.filtro-ativo {
            background: linear-gradient(135deg, var(--laranja) 0%, var(--dourado) 100%);
        }

        .busca-group {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .search-box {
            position: relative;
            flex: 1;
        }

        .search-box input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid var(--cinza-claro);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: var(--branco);
            font-family: inherit;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--azul-marinho);
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: var(--cinza-medio);
        }

        /* ===== PAINEL DE RESULTADOS ===== */
        .resultados-panel {
            background: var(--branco);
            border: 2px solid var(--azul-marinho);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .galeria-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--dourado);
        }

        .galeria-header h3 {
            color: var(--azul-marinho);
            font-size: 20px;
            font-weight: 600;
        }

        .contador {
            color: var(--cinza-medio);
            font-size: 14px;
            font-weight: 600;
        }

        .estado-vazio {
            text-align: center;
            padding: 50px 20px;
            color: var(--cinza-medio);
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .icone-vazio {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .estado-vazio p {
            font-size: 16px;
            line-height: 1.5;
        }

        /* ===== GALERIA DE ALUNOS ===== */
        .galeria-alunos {
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex: 1;
        }

        .aluno-item {
            display: flex;
            background: var(--branco);
            border: 2px solid var(--cinza-claro);
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .aluno-item:hover {
            border-color: var(--azul-marinho);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .aluno-item.selecionado {
            border-color: var(--dourado);
            background: rgba(212, 175, 55, 0.05);
        }

        .aluno-item.selecionado::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--dourado);
        }

        .aluno-foto {
            width: 120px;
            height: 120px;
            background: var(--cinza-claro);
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid var(--cinza-claro);
            flex-shrink: 0;
        }

        .foto-placeholder {
            font-size: 36px;
            color: var(--cinza-medio);
        }

        .aluno-info {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .aluno-nome {
            font-size: 18px;
            font-weight: 600;
            color: var(--azul-marinho);
            margin-bottom: 5px;
        }

        .aluno-local {
            font-size: 14px;
            color: var(--cinza-escuro);
            font-weight: 500;
        }

        .aluno-tipo-prova {
            font-size: 13px;
            color: var(--laranja);
            font-weight: 600;
        }

        .aluno-detalhes {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--cinza-claro);
        }

        .aluno-segmento, .aluno-turma {
            font-size: 12px;
            color: var(--cinza-medio);
            margin-bottom: 3px;
        }

        .separador-aluno {
            height: 8px;
            background: var(--branco);
            width: 100%;
        }

        /* ===== ESTADOS DOS FILTROS ===== */
        .filtro-ativo {
            border-color: var(--laranja) !important;
            background: rgba(255, 107, 53, 0.05) !important;
        }

        .filtro-desativado {
            border-color: var(--cinza-medio) !important;
            background: var(--cinza-claro) !important;
            color: var(--cinza-medio) !important;
        }

        /* ===== RESPONSIVO ===== */
        @media (max-width: 1024px) {
            .content {
                padding: 20px;
            }
            
            .filtro-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filtro-item {
                min-width: auto;
            }
            
            .busca-group {
                flex-direction: column;
            }
        }

        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                flex-direction: row;
            }
            
            .menu-nav {
                display: flex;
                justify-content: space-around;
                padding: 10px 0;
                width: 100%;
            }
            
            .menu-item {
                padding: 10px 5px;
                border-left: none;
                border-bottom: 3px solid transparent;
                flex: 1;
            }
            
            .menu-item.active {
                border-left: none;
                border-bottom-color: var(--dourado);
            }
            
            .menu-tooltip {
                display: none;
            }
            
            .header-content {
                padding: 0 15px;
            }
            
            .logo {
                height: 40px;
            }
            
            .content {
                padding: 15px;
            }
            
            .aluno-item {
                flex-direction: column;
            }
            
            .aluno-foto {
                width: 100%;
                height: 100px;
                border-right: none;
                border-bottom: 1px solid var(--cinza-claro);
            }
            
            .galeria-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        /* ===== ANIMAÇÕES ===== */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .resultados-panel {
            animation: fadeIn 0.6s ease-out;
        }

        .aluno-item {
            animation: fadeIn 0.4s ease-out;
        }

        /* Animação para botão de atualização */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .atualizando {
            animation: pulse 1s ease-in-out;
        }
    </style>
</head>
<body>
    <div class="busca-container">
        <!-- Status da Integração -->
        <div id="status-integracao" class="status-integracao" style="display: none;">
            🔄 Conectando...
        </div>

        <!-- Cabeçalho Simplificado -->
        <header class="header">
            <div class="header-background"></div>
            <div class="header-content">
                <div class="logo-container">
                    <img src="logo-santo-antonio.png" alt="Colégio Santo Antônio" class="logo">
                </div>
            </div>
        </header>

        <!-- Layout Principal -->
        <div class="main-layout">
            <!-- Menu Lateral SEM Logo -->
            <nav class="sidebar">
                <ul class="menu-nav">
                    <li class="menu-item" data-menu="1">
                        <span class="menu-icon">🏠</span>
                        <span class="menu-text">Início</span>
                        <span class="menu-tooltip">Página inicial</span>
                    </li>
                    <li class="menu-item" data-menu="2">
                        <span class="menu-icon">📅</span>
                        <span class="menu-text">Agendar</span>
                        <span class="menu-tooltip">Novo agendamento</span>
                    </li>
                    <li class="menu-item" data-menu="3">
                        <span class="menu-icon">✉️</span>
                        <span class="menu-text">Suporte</span>
                        <span class="menu-tooltip">Contato e suporte</span>
                    </li>
                    <li class="menu-item" data-menu="4">
                        <span class="menu-icon">📆</span>
                        <span class="menu-text">Calendário</span>
                        <span class="menu-tooltip">Visualizar calendário</span>
                    </li>
                    <li class="menu-item active" data-menu="5">
                        <span class="menu-icon">🔍</span>
                        <span class="menu-text">Buscar</span>
                        <span class="menu-tooltip">Busca por alunos</span>
                    </li>
                </ul>
            </nav>

            <!-- Conteúdo Principal -->
            <main class="content">
                <div class="busca-content">
                    <!-- Painel de Filtros -->
                    <div class="filtros-panel">
                        <div class="filtro-group">
                            <div class="filtro-item">
                                <label for="segmento-filtro">Segmento:</label>
                                <select id="segmento-filtro">
                                    <option value="##">##</option>
                                    <option value="Fundamental 1">Fundamental 1</option>
                                    <option value="Fundamental 2">Fundamental 2</option>
                                    <option value="Ensino Médio">Ensino Médio</option>
                                </select>
                            </div>

                            <div class="filtro-item">
                                <label for="turma-filtro">Turma:</label>
                                <select id="turma-filtro" disabled>
                                    <option value="##">##</option>
                                    <!-- Turmas serão carregadas dinamicamente -->
                                </select>
                            </div>

                            <button id="btn-aplicar-filtros" class="btn-filtro">
                                Aplicar Filtros
                            </button>
                            
                            <button id="btn-atualizar" class="btn-filtro" title="Atualizar dados">
                                🔄 Atualizar
                            </button>
                        </div>

                        <div class="busca-group">
                            <div class="search-box">
                                <input type="text" id="input-busca" placeholder="Digite o nome do aluno...">
                                <span class="search-icon">🔍</span>
                            </div>
                        </div>
                    </div>

                    <!-- Galeria de Resultados -->
                    <div class="resultados-panel">
                        <div class="galeria-header">
                            <h3>Resultados da Busca</h3>
                            <span id="contador-resultados" class="contador">0 alunos encontrados</span>
                        </div>

                        <div id="estado-vazio" class="estado-vazio">
                            <div class="icone-vazio">👥</div>
                            <p id="mensagem-vazio">Digite um nome ou aplique filtros para buscar alunos</p>
                        </div>

                        <div id="galeria-alunos" class="galeria-alunos">
                            <!-- Alunos serão carregados via JavaScript -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // ✅ CONFIGURAÇÃO DE URLS ABSOLUTAS
        const BASE_URL = 'https://wandersont-silva.github.io/sistema-agendamento-nap';
        
        // ✅ CONFIGURAÇÃO MICROSOFT EXCEL - ATUALIZADA COM SUA URL E TABELA
        const MS_EXCEL_CONFIG = {
            clientId: '9b518380-2b14-46d7-8a5a-e5a815b48aac',
            tenantId: '9d4a2bfa-8172-4b94-bd8a-eafb5cf478cc',
            redirectUri: `${BASE_URL}/busca.html`,
            excelFileUrl: 'https://inesacsa-my.sharepoint.com/personal/wandeson_silva_santoantonio_edu_br/Documents/PlanilhaAlunos.xlsx',
            excelFileName: 'PlanilhaAlunos.xlsx',
            sheetName: 'AlunosLaudados',
            tableName: 'Table1', // Nome da tabela na planilha
            excelFileId: null // Será extraído automaticamente
        };

        // ✅ CONFIGURAÇÃO MSAL
        const msalConfig = {
            auth: {
                clientId: MS_EXCEL_CONFIG.clientId,
                authority: `https://login.microsoftonline.com/${MS_EXCEL_CONFIG.tenantId}`,
                redirectUri: MS_EXCEL_CONFIG.redirectUri,
                knownAuthorities: ['login.microsoftonline.com']
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: false
            }
        };

        const msalRequest = {
            scopes: [
                "https://graph.microsoft.com/Files.Read.All",
                "https://graph.microsoft.com/User.Read"
            ]
        };

        // ✅ GERENCIADOR DE AUTENTICAÇÃO MSAL
        class MSALAuthManager {
            constructor() {
                this.msalInstance = null;
                this.account = null;
                this.isInitialized = false;
            }

            async initialize() {
                if (this.isInitialized) return;
                
                try {
                    this.msalInstance = new msal.PublicClientApplication(msalConfig);
                    await this.msalInstance.initialize();
                    
                    const response = await this.msalInstance.handleRedirectPromise();
                    if (response) {
                        this.account = response.account;
                        console.log('✅ Login via redirect realizado:', this.account);
                    } else {
                        const accounts = this.msalInstance.getAllAccounts();
                        if (accounts.length > 0) {
                            this.account = accounts[0];
                            console.log('✅ Conta encontrada no cache:', this.account);
                        }
                    }
                    
                    this.isInitialized = true;
                } catch (error) {
                    console.error('❌ Erro ao inicializar MSAL:', error);
                }
            }

            async getAccessToken() {
                if (!this.isInitialized) {
                    await this.initialize();
                }

                if (!this.account) {
                    return null;
                }

                try {
                    const silentRequest = {
                        scopes: msalRequest.scopes,
                        account: this.account,
                        forceRefresh: false
                    };

                    const response = await this.msalInstance.acquireTokenSilent(silentRequest);
                    console.log('✅ Token adquirido silenciosamente');
                    return response.accessToken;

                } catch (silentError) {
                    console.warn('Falha no token silencioso:', silentError);
                    return null;
                }
            }

            isAuthenticated() {
                return this.account !== null;
            }
        }

        // ✅ GERENCIADOR PRINCIPAL DA BUSCA - ATUALIZADO
        class BuscaManager {
            constructor() {
                this.authManager = new MSALAuthManager();
                this.textoBusca = '';
                this.segmentoSelecionado = '##';
                this.turmaSelecionada = '##';
                this.aplicarFiltros = false;
                this.alunoSelecionado = null;
                this.alunos = [];
                this.alunosFiltrados = [];
                
                this.turmasPorSegmento = {
                    'Fundamental 1': ['##', '1ºA', '1ºB', '1ºC', '1ºD', '1ºE', '2ºA', '2ºB', '2ºC', '2ºD', '2ºE', '3ºA', '3ºB', '3ºC', '3ºD', '3ºE', '4ºA', '4ºB', '4ºC', '4ºD', '4ºE', '5ºA', '5ºB', '5ºC', '5ºD', '5ºE'],
                    'Fundamental 2': ['##', '6ºA', '6ºB', '6ºC', '6ºD', '6ºE', '7ºA', '7ºB', '7ºC', '7ºD', '7ºE', '8ºA', '8ºB', '8ºC', '8ºD', '8ºE', '9ºA', '9ºB', '9ºC', '9ºD', '9ºE'],
                    'Ensino Médio': ['##', '1ºA', '1ºB', '1ºC', '1ºD', '1ºE', '2ºA', '2ºB', '2ºC', '2ºD', '2ºE', '3ºA', '3ºB', '3ºC', '3ºD', '3ºE']
                };
                
                this.init();
            }

            async init() {
                await this.authManager.initialize();
                this.checkAuthentication();
                this.setupEventListeners();
                this.setupMenuNavigation();
                await this.testarIntegracaoExcel();
                await this.carregarDadosAlunos();
                this.atualizarTurmas();
                this.renderizarResultados();
            }

            checkAuthentication() {
                const currentUser = localStorage.getItem('currentUser');
                if (!currentUser) {
                    window.location.href = BASE_URL + '/index.html';
                    return;
                }
                this.usuarioLogado = JSON.parse(currentUser);
            }

            setupEventListeners() {
                // Navegação do menu
                document.addEventListener('click', (e) => {
                    const menuItem = e.target.closest('.menu-item');
                    if (menuItem) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const menuId = parseInt(menuItem.getAttribute('data-menu'));
                        this.navigateToMenu(menuId);
                        return false;
                    }
                });

                // Filtros
                document.getElementById('segmento-filtro').addEventListener('change', (e) => {
                    this.segmentoSelecionado = e.target.value;
                    this.atualizarTurmas();
                    this.aplicarFiltros = false;
                    this.atualizarEstadosFiltros();
                    this.renderizarResultados();
                });

                document.getElementById('turma-filtro').addEventListener('change', (e) => {
                    this.turmaSelecionada = e.target.value;
                    this.aplicarFiltros = false;
                    this.atualizarEstadosFiltros();
                    this.renderizarResultados();
                });

                document.getElementById('btn-aplicar-filtros').addEventListener('click', () => {
                    this.aplicarFiltros = true;
                    this.atualizarEstadosFiltros();
                    this.renderizarResultados();
                });

                // Botão atualizar
                document.getElementById('btn-atualizar').addEventListener('click', () => {
                    this.atualizarDados();
                });

                // Busca por texto
                document.getElementById('input-busca').addEventListener('input', (e) => {
                    this.textoBusca = e.target.value.trim();
                    this.renderizarResultados();
                });

                // Enter para buscar
                document.getElementById('input-busca').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.renderizarResultados();
                    }
                });
            }

            setupMenuNavigation() {
                // Remove active de todos os itens
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Adiciona active ao item atual
                document.querySelector('[data-menu="5"]').classList.add('active');
            }

            navigateToMenu(menuId) {
                switch(menuId) {
                    case 1: // Dashboard
                        window.location.href = BASE_URL + '/dashboard.html';
                        break;
                    case 2: // Agendamento
                        window.location.href = BASE_URL + '/agendamento.html';
                        break;
                    case 3: // Suporte
                        window.location.href = BASE_URL + '/suporte.html';
                        break;
                    case 4: // Calendário
                        window.location.href = BASE_URL + '/calendario.html';
                        break;
                    case 5: // Busca (já estamos aqui)
                        break;
                }
            }

            // ✅ MÉTODOS DE INTEGRAÇÃO EXCEL ONLINE - ATUALIZADOS
            async testarIntegracaoExcel() {
                try {
                    this.mostrarStatusIntegracao('🔄 Conectando com Excel Online...');
                    
                    const token = await this.authManager.getAccessToken();
                    if (!token) {
                        this.mostrarStatusIntegracao('⚠️ Um administrador deve permitir', 'erro');
                        return;
                    }

                    // Tentar obter o ID do arquivo pela URL
                    const fileId = await this.obterFileIdPorUrl(token);
                    
                    if (fileId) {
                        MS_EXCEL_CONFIG.excelFileId = fileId;
                        this.mostrarStatusIntegracao('✅ Conectado ao Excel Online', 'conectado');
                        console.log('✅ ID do arquivo obtido:', fileId);
                    } else {
                        this.mostrarStatusIntegracao('⚠️ Não foi possível acessar o arquivo', 'erro');
                    }
                    
                } catch (error) {
                    console.error('❌ Erro na integração:', error);
                    this.mostrarStatusIntegracao('⚠️ Erro ao conectar com Excel Online', 'erro');
                }
            }

            async obterFileIdPorUrl(token) {
                try {
                    // Extrair informações da URL do SharePoint
                    const url = new URL(MS_EXCEL_CONFIG.excelFileUrl);
                    const sitePath = this.extrairSitePath(MS_EXCEL_CONFIG.excelFileUrl);
                    const filePath = this.extrairFilePath(MS_EXCEL_CONFIG.excelFileUrl);
                    
                    console.log('🔍 Procurando arquivo:', { sitePath, filePath });

                    // Buscar o arquivo pelo caminho
                    const response = await fetch(
                        `https://graph.microsoft.com/v1.0/sites/${sitePath}/drive/root:${filePath}`,
                        {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        }
                    );

                    if (response.ok) {
                        const fileInfo = await response.json();
                        console.log('✅ Arquivo encontrado:', fileInfo);
                        return fileInfo.id;
                    } else {
                        console.warn('❌ Arquivo não encontrado pelo caminho, tentando busca...');
                        return await this.buscarArquivoPorNome(token);
                    }
                    
                } catch (error) {
                    console.error('Erro ao obter ID por URL:', error);
                    return null;
                }
            }

            extrairSitePath(siteUrl) {
                const url = new URL(siteUrl);
                // Formato: hostname:caminho-do-site
                return `${url.hostname}:${url.pathname.split('/').slice(0, 3).join('/')}`;
            }

            extrairFilePath(fileUrl) {
                const url = new URL(fileUrl);
                // Extrair o caminho do arquivo a partir de /Documents/
                const documentsIndex = url.pathname.indexOf('/Documents/');
                if (documentsIndex !== -1) {
                    return url.pathname.substring(documentsIndex);
                }
                return url.pathname;
            }

            async buscarArquivoPorNome(token) {
                try {
                    // Buscar por nome do arquivo
                    const response = await fetch(
                        `https://graph.microsoft.com/v1.0/me/drive/root/search(q='${MS_EXCEL_CONFIG.excelFileName}')?$select=id,name,webUrl`,
                        {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        }
                    );

                    if (response.ok) {
                        const data = await response.json();
                        const arquivo = data.value.find(file => 
                            file.name === MS_EXCEL_CONFIG.excelFileName
                        );
                        
                        if (arquivo) {
                            console.log('✅ Arquivo encontrado por nome:', arquivo);
                            return arquivo.id;
                        }
                    }
                } catch (error) {
                    console.error('Erro na busca por nome:', error);
                }
                return null;
            }

            mostrarStatusIntegracao(mensagem, tipo = '') {
                const statusElement = document.getElementById('status-integracao');
                if (statusElement) {
                    statusElement.textContent = mensagem;
                    statusElement.className = `status-integracao ${tipo}`;
                    statusElement.style.display = 'block';
                }
            }

            async carregarDadosAlunos() {
                try {
                    let alunosDoExcel = null;
                    
                    // Tenta carregar do Excel Online primeiro
                    const token = await this.authManager.getAccessToken();
                    if (token && MS_EXCEL_CONFIG.excelFileId) {
                        alunosDoExcel = await this.carregarDoExcelOnline(token);
                    }

                    if (alunosDoExcel && alunosDoExcel.length > 0) {
                        this.alunos = alunosDoExcel;
                        console.log('✅ Alunos carregados do Excel Online:', this.alunos.length);
                        
                        // Salvar no localStorage como backup
                        localStorage.setItem(`alunos_${this.usuarioLogado.email}`, JSON.stringify(this.alunos));
                    } else {
                        // Fallback para localStorage
                        await this.carregarAlunosLocal();
                    }
                    
                } catch (error) {
                    console.error('Erro ao carregar alunos:', error);
                    await this.carregarAlunosLocal();
                }
            }

            async carregarDoExcelOnline(token) {
                try {
                    if (!MS_EXCEL_CONFIG.excelFileId) {
                        throw new Error('ID do arquivo não disponível');
                    }

                    console.log('📊 Tentando carregar dados da tabela:', MS_EXCEL_CONFIG.tableName);
                    
                    // ✅ OPÇÃO 1: Tentar carregar dados da tabela nomeada (mais eficiente)
                    let response = await fetch(
                        `https://graph.microsoft.com/v1.0/me/drive/items/${MS_EXCEL_CONFIG.excelFileId}/workbook/worksheets('${MS_EXCEL_CONFIG.sheetName}')/tables('${MS_EXCEL_CONFIG.tableName}')/rows`,
                        {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        }
                    );

                    if (response.ok) {
                        console.log('✅ Dados carregados da tabela nomeada');
                        const data = await response.json();
                        return this.processarDadosTabela(data);
                    } else {
                        console.warn('❌ Tabela não encontrada, tentando usedRange...');
                        
                        // ✅ OPÇÃO 2: Fallback para usedRange (método anterior)
                        response = await fetch(
                            `https://graph.microsoft.com/v1.0/me/drive/items/${MS_EXCEL_CONFIG.excelFileId}/workbook/worksheets('${MS_EXCEL_CONFIG.sheetName}')/usedRange`,
                            {
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                }
                            }
                        );

                        if (!response.ok) {
                            throw new Error(`Erro HTTP: ${response.status}`);
                        }

                        const data = await response.json();
                        console.log('📊 Dados carregados via usedRange');
                        return this.processarDadosPlanilha(data);
                    }
                    
                } catch (error) {
                    console.warn('Não foi possível carregar do Excel Online:', error);
                    return null;
                }
            }

            // ✅ NOVO MÉTODO: Processar dados de tabela nomeada
            processarDadosTabela(data) {
                const alunos = [];
                
                console.log('📋 Estrutura da tabela:', data);

                if (data.value && Array.isArray(data.value)) {
                    console.log('📊 Total de linhas na tabela:', data.value.length);
                    
                    // Em tabelas nomeadas, cada item em 'value' é uma linha da tabela
                    data.value.forEach((linha, index) => {
                        if (linha.values && Array.isArray(linha.values) && linha.values[0]) {
                            const valores = linha.values[0]; // Os valores estão em um array interno
                            
                            // Verificar se é a linha de cabeçalho (geralmente índice 0)
                            if (index === 0) {
                                console.log('📝 Cabeçalhos da tabela:', valores);
                                return; // Pular linha de cabeçalho
                            }
                            
                            // Verificar se a linha tem dados válidos
                            if (valores.length >= 1 && valores[0]) {
                                const aluno = {
                                    id: index,
                                    nome: valores[0]?.toString().trim() || 'Nome não informado',
                                    turma: valores[1]?.toString().trim() || 'Turma não informada',
                                    segmento: valores[2]?.toString().trim() || 'Segmento não informado',
                                    tipoProva: valores[3]?.toString().trim() || 'Tipo não informado',
                                    localProva: valores[4]?.toString().trim() || 'Local não informado',
                                    foto: null
                                };
                                
                                alunos.push(aluno);
                                console.log(`👤 Aluno ${index}:`, aluno.nome);
                            }
                        }
                    });
                } else {
                    console.warn('❌ Estrutura de tabela inesperada:', data);
                }
                
                console.log(`✅ Total de alunos processados: ${alunos.length}`);
                return alunos;
            }

            // ✅ MÉTODO ORIGINAL (como fallback)
            processarDadosPlanilha(data) {
                const alunos = [];
                
                if (data.values && Array.isArray(data.values)) {
                    console.log('📋 Total de linhas na planilha:', data.values.length);
                    
                    // A primeira linha geralmente é o cabeçalho
                    for (let i = 1; i < data.values.length; i++) {
                        const linha = data.values[i];
                        
                        if (linha && linha.length >= 1 && linha[0]) {
                            const aluno = {
                                id: i,
                                nome: linha[0]?.toString().trim() || 'Nome não informado',
                                turma: linha[1]?.toString().trim() || 'Turma não informada',
                                segmento: linha[2]?.toString().trim() || 'Segmento não informado',
                                tipoProva: linha[3]?.toString().trim() || 'Tipo não informado',
                                localProva: linha[4]?.toString().trim() || 'Local não informado',
                                foto: null
                            };
                            
                            alunos.push(aluno);
                            console.log(`👤 Aluno ${i}:`, aluno.nome);
                        }
                    }
                } else {
                    console.warn('❌ Estrutura de dados inesperada:', data);
                }
                
                return alunos;
            }

            async carregarAlunosLocal() {
                // Tenta carregar do localStorage primeiro
                const alunosSalvos = localStorage.getItem(`alunos_${this.usuarioLogado.email}`);
                
                if (alunosSalvos) {
                    this.alunos = JSON.parse(alunosSalvos);
                    console.log('📁 Alunos carregados localmente:', this.alunos.length);
                } else {
                    // Dados de exemplo como fallback (usando os dados que você forneceu)
                    this.alunos = [
                        {
                            id: 1,
                            nome: 'Agatha Scolete Correia',
                            segmento: 'Ensino Médio',
                            turma: '1ºA',
                            localProva: 'Fora de sala',
                            tipoProva: 'Adaptada',
                            foto: null
                        },
                        {
                            id: 2,
                            nome: 'Alice Hebling Vegini',
                            segmento: 'Fundamental 2',
                            turma: '8ºA',
                            localProva: 'Fora de sala',
                            tipoProva: 'Sem Adaptação',
                            foto: null
                        },
                        {
                            id: 3,
                            nome: 'Alice Tosta Mendes da Silveira',
                            segmento: 'Fundamental 2',
                            turma: '8ºA',
                            localProva: 'Fora de sala - Apenas em Matemática',
                            tipoProva: 'Sem Adaptação',
                            foto: null
                        },
                        {
                            id: 4,
                            nome: 'Alice Vinter Corrêa',
                            segmento: 'Fundamental 1',
                            turma: '5ºB',
                            localProva: 'Fora de sala',
                            tipoProva: 'Sem Adaptação',
                            foto: null
                        }
                    ];
                    console.log('📋 Usando dados de exemplo:', this.alunos.length);
                }
            }

            async atualizarDados() {
                const btnAtualizar = document.getElementById('btn-atualizar');
                btnAtualizar.classList.add('atualizando');
                
                try {
                    await this.carregarDadosAlunos();
                    this.renderizarResultados();
                    this.mostrarStatusIntegracao('✅ Dados atualizados!', 'conectado');
                    
                    setTimeout(() => {
                        this.mostrarStatusIntegracao('✅ Conectado ao Excel Online', 'conectado');
                    }, 2000);
                    
                } catch (error) {
                    this.mostrarStatusIntegracao('❌ Erro na atualização', 'erro');
                } finally {
                    setTimeout(() => {
                        btnAtualizar.classList.remove('atualizando');
                    }, 1000);
                }
            }

            atualizarTurmas() {
                const selectTurma = document.getElementById('turma-filtro');
                
                if (this.segmentoSelecionado === '##') {
                    selectTurma.innerHTML = '<option value="##">##</option>';
                    selectTurma.disabled = true;
                } else {
                    selectTurma.disabled = false;
                    selectTurma.innerHTML = '';
                    
                    const turmas = this.turmasPorSegmento[this.segmentoSelecionado] || [];
                    turmas.forEach(turma => {
                        const option = document.createElement('option');
                        option.value = turma;
                        option.textContent = turma;
                        selectTurma.appendChild(option);
                    });
                    
                    // Reseta a turma selecionada
                    this.turmaSelecionada = '##';
                    selectTurma.value = '##';
                }
            }

            atualizarEstadosFiltros() {
                const selectSegmento = document.getElementById('segmento-filtro');
                const selectTurma = document.getElementById('turma-filtro');
                const btnAplicar = document.getElementById('btn-aplicar-filtros');

                // Atualiza estado do segmento
                if (this.textoBusca) {
                    selectSegmento.classList.add('filtro-desativado');
                    selectSegmento.disabled = true;
                } else {
                    selectSegmento.classList.remove('filtro-desativado');
                    selectSegmento.disabled = false;
                }

                // Atualiza estado da turma
                if (this.textoBusca || this.segmentoSelecionado === '##') {
                    selectTurma.classList.add('filtro-desativado');
                    selectTurma.disabled = true;
                } else {
                    selectTurma.classList.remove('filtro-desativado');
                    selectTurma.disabled = false;
                }

                // Atualiza estado do botão aplicar
                if (this.aplicarFiltros) {
                    btnAplicar.classList.add('filtro-ativo');
                } else {
                    btnAplicar.classList.remove('filtro-ativo');
                }
            }

            filtrarAlunos() {
                let alunosFiltrados = [...this.alunos];

                // Filtro por texto de busca (tem prioridade)
                if (this.textoBusca) {
                    const termo = this.textoBusca.toLowerCase();
                    alunosFiltrados = alunosFiltrados.filter(aluno => 
                        aluno.nome.toLowerCase().includes(termo) ||
                        aluno.nome.toLowerCase().startsWith(termo)
                    );
                } 
                // Filtro por segmento/turma (quando não há busca por texto)
                else if (this.aplicarFiltros) {
                    if (this.segmentoSelecionado !== '##') {
                        alunosFiltrados = alunosFiltrados.filter(aluno => 
                            aluno.segmento === this.segmentoSelecionado
                        );
                    }

                    if (this.turmaSelecionada !== '##') {
                        alunosFiltrados = alunosFiltrados.filter(aluno => 
                            aluno.turma === this.turmaSelecionada
                        );
                    }
                }

                this.alunosFiltrados = alunosFiltrados;
            }

            renderizarResultados() {
                this.filtrarAlunos();
                this.atualizarEstadosFiltros();

                const galeria = document.getElementById('galeria-alunos');
                const estadoVazio = document.getElementById('estado-vazio');
                const mensagemVazio = document.getElementById('mensagem-vazio');
                const contador = document.getElementById('contador-resultados');

                galeria.innerHTML = '';

                // Atualiza contador
                contador.textContent = `${this.alunosFiltrados.length} aluno(s) encontrado(s)`;

                if (this.alunosFiltrados.length === 0) {
                    estadoVazio.style.display = 'flex';
                    
                    if (this.textoBusca) {
                        mensagemVazio.textContent = `Nenhum aluno encontrado para "${this.textoBusca}"`;
                    } else if (this.aplicarFiltros) {
                        mensagemVazio.textContent = 'Nenhum aluno encontrado com os filtros aplicados';
                    } else {
                        mensagemVazio.textContent = 'Digite um nome ou aplique filtros para buscar alunos';
                    }
                } else {
                    estadoVazio.style.display = 'none';
                    
                    this.alunosFiltrados.forEach(aluno => {
                        const alunoElemento = this.criarElementoAluno(aluno);
                        galeria.appendChild(alunoElemento);
                    });
                }
            }

            criarElementoAluno(aluno) {
                const alunoElemento = document.createElement('div');
                alunoElemento.className = 'aluno-item';
                
                if (this.alunoSelecionado && this.alunoSelecionado.id === aluno.id) {
                    alunoElemento.classList.add('selecionado');
                }

                alunoElemento.innerHTML = `
                    <div class="aluno-foto">
                        <div class="foto-placeholder">👤</div>
                    </div>
                    <div class="aluno-info">
                        <div class="aluno-nome">${aluno.nome}</div>
                        <div class="aluno-local">${aluno.localProva}</div>
                        <div class="aluno-tipo-prova">${aluno.tipoProva}</div>
                        <div class="aluno-detalhes">
                            <div class="aluno-segmento">Segmento: ${aluno.segmento}</div>
                            <div class="aluno-turma">Turma: ${aluno.turma}</div>
                        </div>
                    </div>
                    <div class="separador-aluno"></div>
                `;

                alunoElemento.addEventListener('click', () => {
                    this.selecionarAluno(aluno);
                });

                return alunoElemento;
            }

            selecionarAluno(aluno) {
                this.alunoSelecionado = aluno;
                this.renderizarResultados();
                
                console.log('Aluno selecionado:', aluno);
                this.mostrarDetalhesAluno(aluno);
            }

            mostrarDetalhesAluno(aluno) {
                alert(`Detalhes do aluno:\n\nNome: ${aluno.nome}\nSegmento: ${aluno.segmento}\nTurma: ${aluno.turma}\nLocal: ${aluno.localProva}\nTipo: ${aluno.tipoProva}`);
            }
        }

        // Inicializar quando a página carregar
        document.addEventListener('DOMContentLoaded', () => {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = BASE_URL + '/index.html';
                return;
            }
            
            new BuscaManager();
        });
    </script>
</body>
</html>

